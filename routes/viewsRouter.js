import { Router } from "express";
import { ProductManager } from "../src/dao/filesystem/productManager.js";
import productModel from "../src/dao/models/product.model.js";
import cartModel from "../src/dao/models/cart.model.js";
import CartManager from "../src/dao/database/cartManager.js";
import handlebars from "express-handlebars";
import publicRoutes from "../src/middlewares/publicRoutes.js";
import privateRoutes from "../src/middlewares/privateRoutes.js";
import { getProdFilterPaginateController } from "../src/Controllers/ProductController.js";
import { createCartController, getCartByIdController, getCartsController, addProductToCartController, updateAllCartController, deleteCartController } from '../src/Controllers/CartController.js';
import { updateController } from "../src/Controllers/ProductController.js";
import { getCartByIdService } from "../src/Services/CartServices.js";
import { getTicketByIdService } from "../src/Services/TicketServices.js";
import { logger } from '../src/utils/logger.js';
import sendMail from '../src/Services/mail.service.js';

const productManager = new ProductManager();

const cartManager = new CartManager();

const router = Router();



//router de Productos y paginaciÃ³n:
router.get("/products", privateRoutes, async (req, res) => {
    await getProdFilterPaginateController(req, res);
    logger.info("info");
    logger.error("error");
    logger.http("http")
});

router.get('/', async (req, res) => {
    const products = await productManager.getProducts();
    res.render('login', { products });
});

router.get('/realtimeproducts', privateRoutes, async (req, res) => {
    const products = await productManager.getProducts();
    res.render('realTimeProducts', {});
});

router.get('/messages', privateRoutes, async (req, res) => res.render('chat',
    {}));

router.get('/verimg', privateRoutes, async (req, res) => res.render('add',
    {}));

router.get('/carts/:cid', privateRoutes, async (req, res) => {
    const cart = await cartManager.getCartById(req.params.cid);
    res.render('cart', { cart })
});

router.get('/carts/:cid/checkout', privateRoutes, async (req, res) => {
    const users = await getCartByIdService();
    res.render('checkout', { users })
});



router.get('/cookies', privateRoutes, (req, res) => {
    res.render('cookies');
});

router.get('/getCookies', privateRoutes, (req, res) => {
    res.send(req.cookies);
});

router.post('/setCookies', privateRoutes, (req, res) => {
    const { nombre, valor } = req.body;
    res.cookie(nombre, valor, { maxAge: 1000 * 10 }).send('Cookie creada'); // con maxAge se borra la cookie , si no queremos que se borre hay que sacar maxAge
})

router.get('/login', publicRoutes, (req, res) => {
    if (req.session.isLogged) {
        res.redirect('/profile')
    }

    res.render('login')
})

router.get('/signup', publicRoutes, (req, res) => {
    if (req.session.isLogged) {
        return res.redirect('/profile')
    }
    res.render('signup')
})

// Bd de cantidad de visitas (acumulado), inicia con 0
const userVisitDB = {};

router.get('/profile', (req, res) => {
    // Verifica si el usuario ya tiene un contador de visitas
    if (!userVisitDB[req.session.email]) {
        userVisitDB[req.session.email] = 1; // Inicializa el contador si es la primera visita
    } else {
        userVisitDB[req.session.email]++; // Incrementa el contador si no es la primera visita
    }
    // Obtiene la fecha de hoy en formato 'YYYY-MM-DD'
    const dateToday = new Date().toISOString().split('T')[0];
    const { first_name, last_name, email, age, role } = req.session.user;
    res.render('profile', { first_name, last_name, email, age, role, visitCount: userVisitDB[req.session.email], dateToday });
});

router.get('/profileadmin', (req, res) => {
    // Verifica si el usuario ya tiene un contador de visitas
    if (!userVisitDB[req.session.email]) {
        userVisitDB[req.session.email] = 1; // Inicializa el contador si es la primera visita
    } else {
        userVisitDB[req.session.email]++; // Incrementa el contador si no es la primera visita
    }
    // Obtiene la fecha de hoy en formato 'YYYY-MM-DD'
    const dateToday = new Date().toISOString().split('T')[0];
    const { first_name, last_name, email, age, role } = req.session.user;
    res.render('profileadmin', { first_name, last_name, email, age, role, visitCount: userVisitDB[req.session.email], dateToday });
});

router.get('/recover', publicRoutes, (req, res) => {
    res.render('recover')
})

router.get('/logout', privateRoutes, (req, res) => {
    req.session.destroy();
    res.redirect('/login');
});

router.get('/failregister', (req, res) => {
    res.send("Register failure")
});

router.get('/faillogin', (req, res) => {
    res.send("Login failure")
});

router.get('/reset', (req, res) => {
        sendMail(res);
});



export default router;



